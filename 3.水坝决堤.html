<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <title>æ°´åå†³å ¤ - æˆ˜ç•¥ä¾¦æ¢ç‰ˆ</title>  
    <script src="https://cdn.tailwindcss.com"></script>  
    <style>  
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');  
        
        * {  
            box-sizing: border-box;  
        }  
        
        body {  
            font-family: 'Segoe UI', system-ui, sans-serif;  
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);  
            overflow: hidden;  
            margin: 0;  
            padding: 0;  
        }  
        
        .tech-font {  
            font-family: 'Orbitron', monospace;  
        }  
        
        /* å·¥å…·è§£é”åŠ¨ç”» */  
        @keyframes pulse-unlock {  
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }  
            50% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }  
        }  
        
        .unlocked {  
            animation: pulse-unlock 1.5s ease-out 3;  
        }  
        
        /* æ¡£æ¡ˆçº¸å¼ æ•ˆæœ */  
        .archive-paper {  
            background: linear-gradient(to bottom, #fef3c7 0%, #fde68a 100%);  
            box-shadow:   
                0 10px 30px rgba(0,0,0,0.5),  
                inset 0 1px 0 rgba(255,255,255,0.3);  
            border: 1px solid #d97706;  
        }  
        
        /* å·¥å…·æç¤º */  
        .tooltip {  
            position: absolute;  
            bottom: 110%;  
            left: 50%;  
            transform: translateX(-50%);  
            background: rgba(0, 0, 0, 0.9);  
            color: white;  
            padding: 6px 12px;  
            border-radius: 6px;  
            font-size: 12px;  
            white-space: nowrap;  
            opacity: 0;  
            pointer-events: none;  
            transition: opacity 0.3s;  
            z-index: 1000;  
        }  
        
        .tooltip::after {  
            content: '';  
            position: absolute;  
            top: 100%;  
            left: 50%;  
            transform: translateX(-50%);  
            border: 5px solid transparent;  
            border-top-color: rgba(0, 0, 0, 0.9);  
        }  
        
        button:hover .tooltip {  
            opacity: 1;  
        }  
        
        /* ç²’å­æ•ˆæœ */  
        .particle {  
            position: absolute;  
            width: 4px;  
            height: 4px;  
            background: white;  
            border-radius: 50%;  
            pointer-events: none;  
        }  
        
        /* è£‚çº¹æ‚¬åœæç¤º */  
        .crack-tooltip {  
            position: fixed;  
            background: rgba(0, 0, 0, 0.9);  
            color: #fbbf24;  
            padding: 8px 12px;  
            border-radius: 6px;  
            font-size: 14px;  
            pointer-events: none;  
            opacity: 0;  
            transition: opacity 0.3s;  
            z-index: 1000;  
            white-space: nowrap;  
        }  
        
        /* ç§»åŠ¨ç«¯å·¥å…·é¡µç­¾ */  
        .mobile-tabs {  
            display: none;  
        }  
        
        /* ç§»åŠ¨ç«¯é¦–å±å¼•å¯¼ */  
        .mobile-intro-screen {  
            display: none;  
        }  
        
        /* å·¥å…·æç¤ºå…‰åœˆåŠ¨ç”» */
        @keyframes tool-hint-pulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7),
                            0 0 20px rgba(34, 197, 94, 0.4);
            }
            50% { 
                box-shadow: 0 0 0 15px rgba(34, 197, 94, 0),
                            0 0 30px rgba(34, 197, 94, 0.6);
            }
        }
        
        .tool-hint-active {
            animation: tool-hint-pulse 2s ease-out infinite;
            border: 2px solid #22c55e !important;
        }
        
        /* å£°çº³å¼¹çª— */
        .sonar-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            z-index: 50;
            width: 90%;
            max-width: 400px;
        }
        
        /* çƒ­æˆåƒå…³é—­æŒ‰é’® */
        .thermal-close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            background: #dc2626;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.5);
            z-index: 60;
        }

        @media (max-width: 768px) {  
            .desktop-sidebar {  
                display: none !important;  
            }  
            
            .mobile-tabs {  
                display: flex;  
            }  
            
            .mobile-info-panel {  
                max-height: 35vh;  
                overflow-y: auto;  
            }  
            
            .mobile-intro-screen {  
                display: flex;  
            }  
        }  
        
        /* æ¡Œé¢ç«¯ä¸‰æ å¸ƒå±€ */  
        @media (min-width: 769px) {  
            .desktop-layout {  
                display: grid;  
                grid-template-columns: 2fr 60px 1fr;  
                height: calc(100vh - 64px);  
            }  
            
            .mobile-intro-screen {  
                display: none !important;  
            }  
        }  
    </style>  
</head>  
<body class="h-screen flex flex-col select-none">  

    <!-- ç§»åŠ¨ç«¯é¦–å±å¼•å¯¼ -->  
    <div id="intro-screen" class="mobile-intro-screen fixed inset-0 bg-gradient-to-b from-slate-900 to-slate-800 z-[200] flex-col justify-between p-6 overflow-y-auto">  
        <div class="flex-1 flex flex-col justify-center">  
            <h1 class="text-3xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300 mb-4">  
                æ°´åå†³å ¤<br>æˆ˜ç•¥ä¾¦æ¢ç‰ˆ  
            </h1>  
            
            <div class="bg-slate-800/50 rounded-lg border border-blue-500/30 p-4 mb-6">  
                <h2 class="text-lg font-bold text-blue-400 mb-3">ğŸ“– æ¸¸æˆèƒŒæ™¯</h2>  
                <p class="text-sm text-slate-300 leading-relaxed mb-4">  
                    ä¸€åº§è€æ—§æ°´åè“„æ»¡äº†æ°´ï¼Œè€Œä¸‹æ¸¸çš„å†œç”°å´å› å¹²æ—±æ¿’ä¸´ç»æ”¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰¾åˆ°å¤§åæœ€è–„å¼±çš„ä¸€ç‚¹ï¼Œç²¾å‡†å‡»ç©¿å®ƒï¼Œè®©æ°´æµçŒæº‰å†œç”°ã€‚  
                </p>  
                
                <!-- æ¦‚å¿µå›¾ -->  
                <div class="w-full h-48 bg-slate-700/50 rounded-lg border border-slate-600 flex items-center justify-center mb-4">  
                    <img src="æ°´åå†³å ¤æ¦‚å¿µå›¾.png" class="w-full h-full object-cover rounded" alt="æ¦‚å¿µå›¾">  
                </div>  
                
                <h2 class="text-lg font-bold text-amber-400 mb-3">ğŸ¯ æ¸¸æˆç›®æ ‡</h2>  
                <ul class="text-sm text-slate-300 space-y-2 leading-relaxed">  
                    <li>â€¢ å¤§åè¢«åˆ’åˆ†ä¸º <strong class="text-blue-300">Aã€Bã€Cã€D</strong> å››ä¸ªåŒºåŸŸ</li>  
                    <li>â€¢ åŒºåŸŸä¸­çš„<strong class="text-yellow-300">é»‘è‰²çº¿æ¡æ˜¯å¤§åè£‚çº¹</strong>ï¼Œç‚¹å‡»è£‚çº¹å¯å°è¯•å‡»ç©¿</li>  
                    <li>â€¢ ä½ åªæœ‰ <strong class="text-red-400">3æ¬¡å°è¯•æœºä¼š</strong></li>  
                    <li>â€¢ ä½¿ç”¨ä¸‰ç§å·¥å…·äº¤å‰éªŒè¯ï¼Œæ‰¾åˆ°çœŸæ­£çš„è–„å¼±ç‚¹</li>  
                </ul>  
            </div>  
            
            <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-4">  
                <p class="text-sm text-blue-200 text-center italic">  
                    ğŸ’¡ æç¤ºï¼šä¸è¦ç›²ç›®å°è¯•ï¼ŒçœŸæ­£çš„æˆ˜ç•¥å®¶å–„äºæ•´åˆå¤šç»´ä¿¡æ¯  
                </p>  
            </div>  
        </div>  
        
        <button onclick="startGame()" class="w-full bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg mt-6 active:scale-95 transition-transform">  
            å¼€å§‹æ¸¸æˆ â†’  
        </button>  
    </div>  

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <header class="bg-slate-900/90 backdrop-blur border-b border-slate-700 px-4 md:px-6 py-3 flex items-center justify-between gap-4 flex-wrap">
        <!-- å·¦ä¾§ï¼šå€’è®¡æ—¶ + å°è¯•æ¬¡æ•° -->
        <div class="flex items-center gap-3 md:gap-6">
            <!-- å€’è®¡æ—¶ -->
            <div class="flex items-center gap-2 md:gap-3 bg-slate-800 px-3 md:px-4 py-2 rounded-lg border border-slate-700">
                <svg class="w-5 h-5 md:w-6 md:h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                    <div class="text-xs text-slate-400">å‰©ä½™æ—¶é—´</div>
                    <div id="timer" class="text-xl md:text-2xl font-bold text-white tech-font">120</div>
                </div>
            </div>
            
            <!-- å°è¯•æ¬¡æ•° -->
            <div class="flex items-center gap-2 md:gap-3 bg-slate-800 px-3 md:px-4 py-2 rounded-lg border border-slate-700">
                <svg class="w-5 h-5 md:w-6 md:h-6 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/>
                </svg>
                <div>
                    <div class="text-xs text-slate-400">å°è¯•æ¬¡æ•°</div>
                    <div id="attempts" class="text-xl md:text-2xl font-bold text-white tech-font">3/3</div>
                </div>
            </div>
        </div>
        
        <!-- ä¸­å¤®ï¼šæ ‡é¢˜ï¼ˆæ¡Œé¢ç«¯æ˜¾ç¤ºï¼‰ -->
        <h1 class="hidden md:block text-xl lg:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">
            æ°´åå†³å ¤ - æˆ˜ç•¥ä¾¦æ¢ç‰ˆ
        </h1>
        
        <!-- å³ä¾§ï¼šé‡ç½®æŒ‰é’® -->
        <button onclick="restartGame()" class="bg-slate-800 hover:bg-slate-600 text-white px-3 md:px-4 py-2 rounded-lg transition-colors border border-slate-700 flex items-center gap-2 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            é‡ç½®
        </button>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->  
    <main class="flex-1 overflow-hidden">  
        
        <!-- æ¡Œé¢ç«¯ä¸‰æ å¸ƒå±€ -->  
        <div class="desktop-layout hidden md:grid">  
            
            <!-- å·¦æ ï¼šæ¦‚å¿µå›¾+ä¿¡æ¯åŒº+å››åŒºå¤§å -->  
            <div class="flex flex-col bg-slate-900/50 overflow-hidden">  
                
                <!-- æ¦‚å¿µå›¾ä¸ä¿¡æ¯åŒº -->  
                <div class="grid grid-cols-2 gap-4 p-4 border-b border-slate-700">  
                    <!-- æ¦‚å¿µå›¾ -->  
                    <div class="bg-slate-800 rounded-lg border border-slate-700 p-3 flex items-center justify-center">  
                        <svg viewBox="0 0 400 180" class="w-full h-auto">  
                            <defs>  
                                <linearGradient id="water" x1="0" y1="0" x2="0" y2="1">  
                                    <stop offset="0" style="stop-color:#0ea5e9"/>  
                                    <stop offset="1" style="stop-color:#0369a1"/>  
                                </linearGradient>  
                                <linearGradient id="dam" x1="0" y1="0" x2="0" y2="1">  
                                    <stop offset="0" style="stop-color:#475569"/>  
                                    <stop offset="1" style="stop-color:#1e293b"/>  
                                </linearGradient>  
                            </defs>  
                            <rect fill="url(#water)" x="0" y="30" width="180" height="80"/>  
                            <text x="60" y="25" font-size="12" fill="#fff" font-family="sans-serif">è“„æ°´åŒº</text>  
                            <path fill="url(#dam)" d="M170 40 L230 40 L230 150 L170 150 Z"/>  
                            <text x="185" y="100" font-size="12" fill="#fff" font-family="sans-serif">å¤§å</text>  
                            <rect fill="#b45309" x="230" y="110" width="150" height="70"/>  
                            <path stroke="#451a03" stroke-width="2" fill="none" d="M240 120 Q250 115 260 120 M270 125 Q280 120 290 125"/>  
                            <text x="260" y="105" font-size="12" fill="#b45309" font-family="sans-serif">å¹²æ¶¸å†œç”°</text>  
                        </svg>  
                    </div>  
                    
                    <!-- ä¿¡æ¯åŒº -->  
                    <div class="bg-slate-800 rounded-lg border border-blue-500/30 p-3 flex flex-col justify-between">  
                        <div>  
                            <h3 class="text-sm font-bold text-blue-400 mb-2">ğŸ“‹ ä»»åŠ¡ç›®æ ‡</h3>  
                            <p class="text-xs text-slate-300 leading-relaxed">  
                                ABCDå››ä¸ªåŒºåŸŸä¸­çš„<strong class="text-yellow-300">é»‘çº¿æ˜¯å¤§åè£‚çº¹</strong>ï¼Œä½ åªæœ‰<strong class="text-red-400">3æ¬¡å°è¯•æœºä¼š</strong>å‡»ç©¿å¤§åã€‚ç‚¹å‡»è£‚çº¹è¿›è¡Œæ”»å‡»ã€‚  
                            </p>  
                        </div>  
                        <div class="mt-2 text-xs text-amber-400 bg-amber-900/20 rounded p-2">  
                            âš ï¸ è¯·è°¨æ…é€‰æ‹©ï¼Œæ•´åˆå¤šç»´ä¿¡æ¯éªŒè¯ï¼  
                        </div>  
                    </div>  
                </div>  
                
                <!-- å››åŒºå¤§åç”»å¸ƒ -->  
                <div class="flex-1 relative bg-gradient-to-b from-slate-800 to-slate-900 overflow-hidden">  
                    <canvas id="mainCanvas" class="w-full h-full cursor-crosshair"></canvas>  
                    
                    <!-- æ¡£æ¡ˆæµ®çª— -->  
                    <div id="archive-modal" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-96 max-w-[90%] archive-paper rounded-lg p-6 shadow-2xl hidden z-50" style="font-family: 'Courier New', monospace;">  
                        <div class="relative">  
                            <button onclick="closeArchive()" class="absolute -top-4 -right-4 w-8 h-8 bg-red-600 hover:bg-red-700 text-white rounded-full flex items-center justify-center transition-colors shadow-lg font-bold">  
                                Ã—  
                            </button>  
                            
                            <div class="border-b-2 border-amber-800 pb-2 mb-4">  
                                <h3 class="text-xl font-bold text-amber-900">ç»å¯†æ¡£æ¡ˆ #804</h3>  
                                <p class="text-xs text-amber-700 mt-1">æ—¥æœŸï¼š1987å¹´11æœˆ12æ—¥ | å·¥ç¨‹é˜Ÿï¼šç¬¬ä¸ƒåŠ å›ºç»„</p>  
                            </div>  
                            
                            <div class="space-y-3 text-sm text-gray-800 leading-relaxed max-h-96 overflow-y-auto">  
                                <div class="bg-white/50 rounded p-2">  
                                    <p class="font-bold text-amber-900">1ï¼‰1983å¹´ - AåŒº</p>  
                                    <p class="text-xs mt-1">ç»´ä¿®ï¼Œåœ¨æº¢æ´ªé“ä¸Šæ–¹å³ä¾§å®‰è£…çŸ©å½¢é’¢æ¿è¿›è¡ŒåŠ å›ºã€‚</p>  
                                </div>  
                                
                                <div class="bg-white/50 rounded p-2">  
                                    <p class="font-bold text-amber-900">2ï¼‰1985å¹´ - DåŒº</p>  
                                    <p class="text-xs mt-1">ç»´ä¿®ï¼Œåœ¨å¤§ååº•éƒ¨é å³ä½ç½®ä¿®è¡¥æ’æ°´å­”å‘¨å›´çš„çŸ³å—ã€‚</p>  
                                </div>  
                                
                                <div class="bg-white/50 rounded p-2">  
                                    <p class="font-bold text-amber-900">3ï¼‰1987å¹´ - CåŒº</p>  
                                    <p class="text-xs mt-1">ç»´ä¿®ï¼Œé¢„ç®—ä¸è¶³ï¼Œåœ¨"æ°´ä½æ ‡å°ºçº¦5ç±³å’Œ10ç±³å¤„"çš„æ¥ç¼ä½ç½®ä½¿ç”¨é’¢æ¿è¡¥ä¸è¿›è¡Œä¸´æ—¶åŠ å›ºã€‚</p>  
                                </div>  
                                
                                <div class="bg-white/50 rounded p-2">  
                                    <p class="font-bold text-amber-900">4ï¼‰1992å¹´ - BåŒº</p>  
                                    <p class="text-xs mt-1">ä¾‹è¡Œè¡¨é¢é˜²æ°´å±‚ç¿»æ–°ï¼Œæ— ç»“æ„æ€§é—®é¢˜ã€‚</p>  
                                </div>  
                            </div>  
                            
                            <div class="absolute -bottom-2 -right-2 text-6xl text-red-600 opacity-20 font-black transform rotate-12 pointer-events-none select-none">  
                                æœºå¯†  
                            </div>  
                        </div>  
                    </div>  
                    
                    <!-- ç³»ç»Ÿæç¤ºæ  -->  
                    <div class="absolute bottom-4 left-4 right-4 bg-slate-900/80 backdrop-blur border border-blue-500/30 rounded-lg p-3 z-10">  
                        <p id="hint-text" class="text-blue-300 text-sm leading-relaxed">  
                            > ç³»ç»Ÿåˆå§‹åŒ–... ä½¿ç”¨å³ä¾§å·¥å…·å¼€å§‹ä¾¦æµ‹ã€‚  
                        </p>  
                    </div>  
                </div>  
                
            </div>  
            
            <!-- ä¸­æ ï¼šæ°´ä½æ ‡å°º -->  
            <div class="bg-gradient-to-b from-blue-900/30 to-blue-950/30 border-x border-slate-700 relative flex items-center justify-center">  
                <canvas id="rulerCanvas" class="w-full h-full"></canvas>  
            </div>  
            
            <!-- å³æ ï¼šå·¥å…·ç®±+é¢æ¿ -->  
            <div class="desktop-sidebar bg-slate-900 flex flex-col gap-4 p-4 overflow-y-auto border-l border-slate-700">  
                
                <!-- å·¥å…·ç®± -->  
                <div class="bg-slate-800 rounded-lg border border-slate-700 p-3">  
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">ğŸ”§ å·¥å…·ç®±</h3>  
                    <div class="flex flex-col gap-3">  
                        
                        <!-- ç»å¯†æ¡£æ¡ˆ -->  
                        <button id="btn-archive" class="relative px-4 py-3 rounded-lg bg-amber-900/30 border-2 border-amber-500/50 text-amber-400 flex items-center gap-3 hover:bg-amber-900/50 transition-all text-left active-tool" onclick="switchTool('archive')">  
                            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">  
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>  
                            </svg>  
                            <span class="text-sm">ç»å¯†æ¡£æ¡ˆ</span>  
                            <span class="ml-auto text-xs text-green-400 px-2 py-0.5 bg-green-900/30 rounded">å®æ—¶</span>  
                        </button>  
                        
                        <!-- å£°çº³æ¢æµ‹ -->  
                        <button id="btn-sound" class="relative px-4 py-3 rounded-lg bg-slate-800 border-2 border-slate-700 text-slate-500 flex items-center gap-3 cursor-not-allowed transition-all text-left" onclick="switchTool('sound')" disabled>  
                            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">  
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>  
                            </svg>  
                            <span class="text-sm">å£°çº³æ¢æµ‹</span>  
                            <svg class="ml-auto w-4 h-4 text-slate-600" fill="currentColor" viewBox="0 0 20 20">  
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>  
                            </svg>  
                            <div class="absolute bottom-0 left-0 right-0 h-1 bg-slate-700 rounded-b-lg overflow-hidden">  
                                <div id="progress-sound" class="h-full bg-blue-500 w-0"></div>  
                            </div>  
                        </button>  
                        
                        <!-- çƒ­æˆåƒ -->  
                        <button id="btn-thermal" class="relative px-4 py-3 rounded-lg bg-slate-800 border-2 border-slate-700 text-slate-500 flex items-center gap-3 cursor-not-allowed transition-all text-left" onclick="switchTool('thermal')" disabled>  
                            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">  
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/>  
                            </svg>  
                            <span class="text-sm">çƒ­æˆåƒ</span>  
                            <svg class="ml-auto w-4 h-4 text-slate-600" fill="currentColor" viewBox="0 0 20 20">  
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>  
                            </svg>  
                            <div class="absolute bottom-0 left-0 right-0 h-1 bg-slate-700 rounded-b-lg overflow-hidden">  
                                <div id="progress-thermal" class="h-full bg-orange-500 w-0"></div>  
                            </div>  
                        </button>  
                        
                    </div>  
                </div>  
                
                <!-- å£°æ³¢é¢‘è°± -->  
                <div class="bg-slate-800 rounded-lg border border-slate-700 p-3">  
                    <div class="flex justify-between items-center mb-2">  
                        <h3 class="text-xs font-bold text-slate-400 uppercase">å£°çº³é¢‘è°±</h3>  
                        <span class="text-[10px] text-green-400 px-2 py-0.5 bg-green-900/30 rounded animate-pulse">LIVE</span>  
                    </div>  
                    <canvas id="waveCanvas" class="w-full bg-slate-900/50 rounded" height="100"></canvas>  
                    <div class="flex justify-between text-[10px] text-slate-500 mt-2">  
                        <span>AåŒº</span>  
                        <span>BåŒº</span>  
                        <span>CåŒº</span>  
                        <span>DåŒº</span>  
                    </div>  
                </div>  
                
                <!-- åŒºåŸŸçŠ¶æ€æ‘˜è¦ -->  
                <div class="bg-slate-800 rounded-lg border border-slate-700 p-3">  
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">åŒºåŸŸçŠ¶æ€æ‘˜è¦</h3>  
                    <div class="grid grid-cols-2 gap-2">  
                        <div id="status-a" class="bg-slate-700/50 rounded p-2 text-xs">  
                            <div class="text-slate-400 font-bold">AåŒº</div>  
                            <div class="text-slate-500 mt-1">æ³¢åŠ¨æ­£å¸¸</div>  
                        </div>  
                        <div id="status-b" class="bg-slate-700/50 rounded p-2 text-xs">  
                            <div class="text-slate-400 font-bold">BåŒº</div>  
                            <div class="text-slate-500 mt-1">æ³¢åŠ¨æ­£å¸¸</div>  
                        </div>  
                        <div id="status-c" class="bg-slate-700/50 rounded p-2 text-xs">  
                            <div class="text-slate-400 font-bold">CåŒº</div>  
                            <div class="text-orange-400 mt-1">æ³¢åŠ¨åå¼º</div>  
                        </div>  
                        <div id="status-d" class="bg-slate-700/50 rounded p-2 text-xs">  
                            <div class="text-slate-400 font-bold">DåŒº</div>  
                            <div class="text-yellow-400 mt-1">è½»å¾®å¼‚å¸¸</div>  
                        </div>  
                    </div>  
                </div>  
                
                <!-- æ¨ç†è®°å½• -->  
                <div class="bg-slate-800 rounded-lg border border-slate-700 p-3 flex-1">  
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">æ¨ç†è®°å½•</h3>  
                    <div id="reasoning-log" class="space-y-2 text-xs text-slate-400 max-h-40 overflow-y-auto">  
                        <p class="opacity-50">ç­‰å¾…æ•°æ®...</p>  
                    </div>  
                </div>  
                
            </div>  
            
        </div>  
        
        <!-- ç§»åŠ¨ç«¯å¸ƒå±€ -->
        <div class="md:hidden flex flex-col h-full">
            
            <!-- ç³»ç»Ÿæç¤ºæ ï¼ˆç§»åˆ°é¡¶éƒ¨ï¼‰ -->
            <div class="bg-slate-900/80 backdrop-blur border-b border-blue-500/30 px-3 py-2">
                <p id="hint-text-mobile" class="text-blue-300 text-xs leading-relaxed">
                    > ç‚¹å‡»åº•éƒ¨å·¥å…·å¼€å§‹ä¾¦æµ‹
                </p>
            </div>
            
            <!-- ä¸»ç”»å¸ƒå®¹å™¨ -->
            <div class="flex-1 flex relative overflow-hidden">
                <!-- å¤§åç”»å¸ƒ -->
                <div class="flex-1 relative bg-gradient-to-b from-slate-800 to-slate-900">
                    <canvas id="mainCanvasMobile" class="w-full h-full cursor-crosshair"></canvas>
                    
                    <!-- æ¡£æ¡ˆæµ®çª—ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
                    <div id="archive-modal-mobile" class="absolute inset-4 archive-paper rounded-lg p-4 shadow-2xl hidden z-50 overflow-y-auto" style="font-family: 'Courier New', monospace;">
                        <div class="relative">
                            <button onclick="closeArchiveMobile()" class="sticky top-0 float-right w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg font-bold z-10">
                                Ã—
                            </button>
                            
                            <div class="border-b-2 border-amber-800 pb-2 mb-3">
                                <h3 class="text-lg font-bold text-amber-900">ç»å¯†æ¡£æ¡ˆ #804</h3>
                                <p class="text-xs text-amber-700 mt-1">1987å¹´11æœˆ12æ—¥</p>
                            </div>
                            
                            <div class="space-y-2 text-xs text-gray-800 leading-relaxed">
                                <div class="bg-white/50 rounded p-2">
                                    <p class="font-bold text-amber-900">1ï¼‰1983å¹´ - AåŒº</p>
                                    <p class="text-xs mt-1">ç»´ä¿®ï¼Œåœ¨æº¢æ´ªé“ä¸Šæ–¹å³ä¾§å®‰è£…çŸ©å½¢é’¢æ¿è¿›è¡ŒåŠ å›ºã€‚</p>
                                </div>
                                <div class="bg-white/50 rounded p-2">
                                    <p class="font-bold text-amber-900">2ï¼‰1985å¹´ - DåŒº</p>
                                    <p class="text-xs mt-1">ç»´ä¿®ï¼Œåœ¨å¤§ååº•éƒ¨é å³ä½ç½®ä¿®è¡¥æ’æ°´å­”å‘¨å›´çš„çŸ³å—ã€‚</p>
                                </div>
                                <div class="bg-white/50 rounded p-2">
                                    <p class="font-bold text-amber-900">3ï¼‰1987å¹´ - CåŒº</p>
                                    <p class="text-xs mt-1">ç»´ä¿®ï¼Œé¢„ç®—ä¸è¶³ï¼Œåœ¨"æ°´ä½æ ‡å°ºçº¦5ç±³å’Œ10ç±³å¤„"çš„æ¥ç¼ä½ç½®ä½¿ç”¨é’¢æ¿è¡¥ä¸è¿›è¡Œä¸´æ—¶åŠ å›ºã€‚</p>
                                </div>
                                <div class="bg-white/50 rounded p-2">
                                    <p class="font-bold text-amber-900">4ï¼‰1992å¹´ - BåŒº</p>
                                    <p class="text-xs mt-1">ä¾‹è¡Œè¡¨é¢é˜²æ°´å±‚ç¿»æ–°ï¼Œæ— ç»“æ„æ€§é—®é¢˜ã€‚</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å£°çº³å¼¹çª—ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
                    <div id="sonar-modal-mobile" class="sonar-modal hidden">
                        <div class="relative">
                            <button onclick="closeSonarMobile()" class="absolute -top-2 -right-2 w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg font-bold z-10">
                                Ã—
                            </button>
                            
                            <h3 class="text-blue-400 font-bold mb-3 text-sm flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                                </svg>
                                å£°çº³æ¢æµ‹æ³¢å½¢
                            </h3>
                            
                            <canvas id="waveCanvasMobile" class="w-full bg-slate-900/50 rounded mb-3" height="80"></canvas>
                            
                            <h4 class="text-slate-300 font-bold mb-2 text-xs">åŒºåŸŸçŠ¶æ€åˆ†æ</h4>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="bg-slate-700/50 rounded p-2 text-center">
                                    <div class="text-slate-400 font-bold">AåŒº</div>
                                    <div class="text-slate-500 mt-1">æ­£å¸¸</div>
                                </div>
                                <div class="bg-slate-700/50 rounded p-2 text-center">
                                    <div class="text-slate-400 font-bold">BåŒº</div>
                                    <div class="text-slate-500 mt-1">æ­£å¸¸</div>
                                </div>
                                <div class="bg-slate-700/50 rounded p-2 text-center">
                                    <div class="text-slate-400 font-bold">CåŒº</div>
                                    <div class="text-orange-400 mt-1 font-bold">åå¼º</div>
                                </div>
                                <div class="bg-slate-700/50 rounded p-2 text-center">
                                    <div class="text-slate-400 font-bold">DåŒº</div>
                                    <div class="text-yellow-400 mt-1">å¼‚å¸¸</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çƒ­æˆåƒå…³é—­æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
                    <div id="thermal-close-mobile" class="thermal-close-btn hidden" onclick="closeThermalMobile()">
                        Ã—
                    </div>
                </div>
                
                <!-- æ°´ä½æ ‡å°ºï¼ˆå³ä¾§ï¼‰ -->
                <div class="w-12 bg-gradient-to-b from-blue-900/30 to-blue-950/30 border-l border-slate-700 relative">
                    <canvas id="rulerCanvasMobile" class="w-full h-full"></canvas>
                </div>
            </div>
            
            <!-- ç§»åŠ¨ç«¯å·¥å…·é¡µç­¾ -->
            <div class="mobile-tabs bg-slate-900 border-t border-slate-700 flex">
                <button onclick="switchToolMobile('archive')" class="flex-1 py-3 text-amber-400 border-b-2 border-amber-500 flex flex-col items-center gap-1" id="tab-archive">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="text-xs">æ¡£æ¡ˆ</span>
                </button>
                <button onclick="switchToolMobile('sound')" class="flex-1 py-3 text-slate-500 flex flex-col items-center gap-1 cursor-not-allowed" id="tab-sound" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <span class="text-xs">å£°çº³</span>
                </button>
                <button onclick="switchToolMobile('thermal')" class="flex-1 py-3 text-slate-500 flex flex-col items-center gap-1 cursor-not-allowed" id="tab-thermal" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/>
                    </svg>
                    <span class="text-xs">çƒ­æˆåƒ</span>
                </button>
            </div>
            
            <!-- ç§»åŠ¨ç«¯ä¿¡æ¯é¢æ¿ï¼ˆæ ¹æ®tabåˆ‡æ¢ï¼‰ -->
            <div class="mobile-info-panel bg-slate-800 p-3" id="mobile-panel">
                <!-- æ¡£æ¡ˆé¢æ¿ -->
                <div id="panel-archive" class="">
                    <p class="text-sm text-amber-300">ğŸ“„ ç‚¹å‡»æŸ¥é˜…å†å²ç»´ä¿®è®°å½•ï¼Œå¯»æ‰¾è–„å¼±ç‚¹çº¿ç´¢</p>
                </div>
                
                <!-- å£°çº³é¢æ¿ -->
                <div id="panel-sound" class="hidden">
                    <p class="text-sm text-blue-300">ğŸ“Š ç‚¹å‡»æŸ¥çœ‹å£°çº³æ¢æµ‹æ•°æ®å’ŒåŒºåŸŸçŠ¶æ€åˆ†æ</p>
                </div>
                
                <!-- çƒ­æˆåƒé¢æ¿ -->
                <div id="panel-thermal" class="hidden">
                    <p class="text-sm text-orange-300">ğŸŒ¡ï¸ çƒ­æˆåƒæ¨¡å¼å·²æ¿€æ´»ï¼Œç‚¹å‡»å¤§åè§‚å¯Ÿæ¸©åº¦åˆ†å¸ƒ</p>
                </div>
            </div>
        </div>
        
    </main>  

    <!-- è£‚çº¹æ‚¬åœæç¤º -->  
    <div id="crack-tooltip" class="crack-tooltip">å¤§åä¸Šçš„è£‚çº¹</div>  

    <!-- ç»“å±€æ¨¡æ€æ¡† -->  
    <div id="end-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[100] p-4">  
        <div id="end-content" class="bg-slate-800 rounded-2xl border-2 border-slate-600 max-w-2xl w-full p-6 md:p-8 shadow-2xl max-h-[90vh] overflow-y-auto">  
            <!-- åŠ¨æ€å†…å®¹ -->  
        </div>  
    </div>  

    <script>  
        // ==================== æ¸¸æˆçŠ¶æ€ ====================  
        const state = {  
            // Canvas  
            canvas: null,  
            ctx: null,  
            rulerCanvas: null,  
            rulerCtx: null,  
            waveCanvas: null,  
            waveCtx: null,  
            
            width: 0,  
            height: 0,  
            
            // æ¸¸æˆçŠ¶æ€  
            timer: 120,  
            interval: null,  
            gameRunning: false,  
            gameStarted: false, // æ˜¯å¦å·²å¼€å§‹æ¸¸æˆï¼ˆè·³è¿‡é¦–å±ï¼‰  
            
            // å°è¯•æ¬¡æ•°  
            maxAttempts: 3,  
            remainingAttempts: 3,  
            
            // å·¥å…·çŠ¶æ€  
            activeMode: 'archive',  
            toolsUnlocked: {  
                archive: true,  
                sound: false,  
                thermal: false  
            },  
            
            intel: {  
                archive: false,  
                sound: false,  
                thermal: false  
            },  
            
            // å¤§åæ•°æ®  
            zones: ['A', 'B', 'C', 'D'],  
            targetZone: 2, // CåŒº  
            
            // è£‚çº¹  
            cracks: [],  
            weakPoints: [], // çœŸæ­£çš„è–„å¼±ç‚¹ï¼ˆ5ç±³å’Œ10ç±³å¤„ï¼‰  
            
            // çƒ­æˆåƒå…‰æ–‘æ•°æ®  
            thermalSpots: [],  
            
            // ç»Ÿè®¡  
            clickCount: 0,  
            wrongClicks: 0,  
            
            // å“åº”å¼  
            isMobile: window.innerWidth < 769,  
            
            // æ‚¬åœçŠ¶æ€  
            hoveredCrack: null,  
            tooltipTimer: null  
        };  

        // ==================== åˆå§‹åŒ– ====================  
        window.onload = function() {  
            initCanvases();  
            
            window.addEventListener('resize', () => {  
                const wasMobile = state.isMobile;  
                state.isMobile = window.innerWidth < 769;  
                if (wasMobile !== state.isMobile) {  
                    location.reload();  
                }  
                resizeCanvas();  
            });  
            
            // æ£€æŸ¥æ˜¯å¦ç§»åŠ¨ç«¯ï¼Œæ˜¾ç¤ºé¦–å±  
            if (state.isMobile) {  
                document.getElementById('intro-screen').style.display = 'flex';  
            } else {  
                startGame(); // æ¡Œé¢ç«¯ç›´æ¥å¼€å§‹  
            }  
            
            requestAnimationFrame(gameLoop);  
        };  

        function startGame() {  
            state.gameStarted = true;  
            if (state.isMobile) {  
                document.getElementById('intro-screen').style.display = 'none';  
            }  
            restartGame();  
        }  

        function initCanvases() {  
            if (state.isMobile) {  
                state.canvas = document.getElementById('mainCanvasMobile');  
                state.ctx = state.canvas.getContext('2d');  
                state.rulerCanvas = document.getElementById('rulerCanvasMobile');  
                state.rulerCtx = state.rulerCanvas.getContext('2d');  
                state.waveCanvas = document.getElementById('waveCanvasMobile');  
                state.waveCtx = state.waveCanvas.getContext('2d');  
            } else {  
                state.canvas = document.getElementById('mainCanvas');  
                state.ctx = state.canvas.getContext('2d');  
                state.rulerCanvas = document.getElementById('rulerCanvas');  
                state.rulerCtx = state.rulerCanvas.getContext('2d');  
                state.waveCanvas = document.getElementById('waveCanvas');  
                state.waveCtx = state.waveCanvas.getContext('2d');  
            }  
            
            state.canvas.addEventListener('click', handleCanvasClick);  
            state.canvas.addEventListener('mousemove', handleCanvasHover);  
            state.canvas.addEventListener('touchmove', handleCanvasTouchMove, { passive: false });  
            state.canvas.addEventListener('mouseleave', hideTooltip);  
            
            resizeCanvas();  
        }  

        function resizeCanvas() {  
            if (state.canvas) {  
                state.canvas.width = state.canvas.offsetWidth;  
                state.canvas.height = state.canvas.offsetHeight;  
                state.width = state.canvas.width;  
                state.height = state.canvas.height;  
            }  
            
            if (state.rulerCanvas) {  
                state.rulerCanvas.width = state.rulerCanvas.offsetWidth;  
                state.rulerCanvas.height = state.rulerCanvas.offsetHeight;  
            }  
            
            if (state.waveCanvas) {  
                state.waveCanvas.width = state.waveCanvas.offsetWidth;  
            }  
            
            // é‡æ–°ç”Ÿæˆè£‚çº¹ï¼ˆå¦‚æœå·²ç»ç”Ÿæˆè¿‡ï¼‰  
            if (state.cracks.length > 0) {  
                generateCracks();  
            }  
        }  

        function restartGame() {  
            // é‡ç½®çŠ¶æ€  
            state.timer = 120;  
            state.gameRunning = true;  
            state.activeMode = 'archive';  
            state.toolsUnlocked = { archive: true, sound: false, thermal: false };  
            state.intel = { archive: false, sound: false, thermal: false };  
            state.remainingAttempts = state.maxAttempts;  
            state.clickCount = 0;  
            state.wrongClicks = 0;  
            
            // é‡ç½®UI  
            document.getElementById('timer').textContent = '120';  
            updateAttemptsUI();  
            resetButtons();  
            closeArchive();  
            if (state.isMobile) closeArchiveMobile();  
            document.getElementById('end-modal').classList.add('hidden');  
            document.getElementById('end-modal').classList.remove('flex');  
            updateHint('> ç»å¯†æ¡£æ¡ˆå·²è§£é”ã€‚æŸ¥é˜…ç»´ä¿®è®°å½•ï¼Œå¯»æ‰¾çº¿ç´¢ã€‚');  
            
            // ç”Ÿæˆè£‚çº¹å’Œçƒ­æˆåƒæ•°æ®  
            generateCracks();  
            generateThermalSpots();  
            
            // å¯åŠ¨è®¡æ—¶å™¨  
            if (state.interval) clearInterval(state.interval);  
            state.interval = setInterval(tick, 1000);  
            
            if (state.isMobile) {
                // ç§»åŠ¨ç«¯ä¸è‡ªåŠ¨æ‰“å¼€æ¡£æ¡ˆï¼Œåªæ·»åŠ æç¤ºå…‰åœˆ
                const archiveTab = document.getElementById('tab-archive');
                if (archiveTab) {
                    archiveTab.classList.add('tool-hint-active');
                    setTimeout(() => {
                        archiveTab.classList.remove('tool-hint-active');
                    }, 5000);
                }
            } else {
                switchTool('archive');
            }
        }  

        function tick() {  
            if (!state.gameRunning) return;  
            
            state.timer--;  
            document.getElementById('timer').textContent = state.timer;  
            
            const elapsed = 120 - state.timer;  
            
            // è§£é”å£°çº³æ¢æµ‹ (20s)  
            if (elapsed === 20 && !state.toolsUnlocked.sound) {  
                unlockTool('sound');  
                updateHint('> [ç³»ç»Ÿé€šçŸ¥] å£°çº³æ¢æµ‹ç³»ç»Ÿå·²å°±ç»ªã€‚åˆ‡æ¢æŸ¥çœ‹å£°æ³¢å¼‚å¸¸åˆ†åŒºã€‚');  
            }  
            if (elapsed < 20) {  
                const progress = (elapsed / 20) * 100;  
                const progressBar = document.getElementById('progress-sound');  
                if (progressBar) progressBar.style.width = `${progress}%`;  
            }  
            
            // è§£é”çƒ­æˆåƒ (30s)  
            if (elapsed === 30 && !state.toolsUnlocked.thermal) {  
                unlockTool('thermal');  
                updateHint('> [ç³»ç»Ÿé€šçŸ¥] çƒ­æˆåƒæ‰«æä»ªå·²å°±ç»ªã€‚åˆ‡æ¢æŸ¥çœ‹æ¸©åº¦å¼‚å¸¸åŒºåŸŸã€‚');  
            }  
            if (elapsed < 30) {  
                const progress = (elapsed / 30) * 100;  
                document.getElementById('progress-thermal').style.width = `${progress}%`;  
            }  
            
            // æ—¶é—´åˆ°  
            if (state.timer <= 0) {  
                endGame(false, 'æ—¶é—´è€—å°½');  
            }  
        }  

        function unlockTool(tool) {
            state.toolsUnlocked[tool] = true;
            
            if (state.isMobile) {
                const btn = document.getElementById(`tab-${tool}`);
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('cursor-not-allowed', 'text-slate-500');
                    btn.classList.add('text-slate-300', 'tool-hint-active'); // æ·»åŠ æç¤ºå…‰åœˆ
                    
                    // 3ç§’åç§»é™¤å…‰åœˆ
                    setTimeout(() => {
                        btn.classList.remove('tool-hint-active');
                    }, 5000);
                }
            } else {
                const btn = document.getElementById(`btn-${tool}`);
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('cursor-not-allowed', 'bg-slate-800', 'border-slate-700', 'text-slate-500');
                    btn.classList.add('unlocked', 'bg-slate-700', 'border-slate-600', 'text-slate-300', 'hover:bg-slate-600');
                    const lock = btn.querySelector('svg[fill="currentColor"]');
                    if (lock) lock.remove();
                }
            }
        }

        function switchTool(mode) {  
            if (!state.toolsUnlocked[mode]) return;  
            
            state.activeMode = mode;  
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€  
            ['archive', 'sound', 'thermal'].forEach(t => {  
                const btn = document.getElementById(`btn-${t}`);  
                if (btn) {  
                    if (t === mode) {  
                        btn.classList.add('border-blue-500', 'bg-blue-900/30', 'active-tool');  
                        btn.classList.remove('border-slate-600', 'bg-slate-700', 'border-amber-500', 'bg-amber-900/30');  
                        if (t === 'archive') {  
                            btn.classList.remove('border-amber-500', 'bg-amber-900/30');  
                        }  
                    } else {  
                        btn.classList.remove('border-blue-500', 'bg-blue-900/30', 'active-tool');  
                        if (t === 'archive' && state.toolsUnlocked[t]) {  
                            btn.classList.add('border-amber-500', 'bg-amber-900/30');  
                        } else if (state.toolsUnlocked[t]) {  
                            btn.classList.add('border-slate-600', 'bg-slate-700');  
                        }  
                    }  
                }  
            });  
            
            // æ¨¡å¼ç‰¹å®šé€»è¾‘  
            if (mode === 'archive') {  
                document.getElementById('archive-modal').classList.remove('hidden');  
                state.intel.archive = true;  
                updateHint('> æ­£åœ¨æŸ¥é˜…å†å²æ¡£æ¡ˆ... æ³¨æ„CåŒºçš„ä¸´æ—¶ä¿®è¡¥è®°å½•ã€‚');  
                addReasoningLog('ğŸ“„ æ¡£æ¡ˆæ˜¾ç¤ºï¼šCåŒº"5ç±³å’Œ10ç±³å¤„"æœ‰ä¸´æ—¶ä¿®è¡¥ç‚¹');  
            } else {  
                closeArchive();  
            }  
            
            if (mode === 'thermal') {  
                state.intel.thermal = true;  
                updateHint('> çƒ­æˆåƒæ¨¡å¼å·²å¯åŠ¨ã€‚ç•™æ„CåŒºå’ŒDåŒºçš„è“è‰²ä½æ¸©å…‰æ–‘ã€‚');  
                addReasoningLog('ğŸŒ¡ï¸ çƒ­æˆåƒï¼šCåŒºæœ‰3å—è“è‰²å…‰æ–‘ï¼ŒDåŒºæœ‰1å—å¤§é¢ç§¯æµ…è“å…‰æ–‘');  
            }  
            
            if (mode === 'sound') {  
                state.intel.sound = true;  
                updateHint('> å£°çº³æ¢æµ‹å¯åŠ¨ã€‚è§‚å¯ŸCåŒºå’ŒDåŒºçš„å£°æ³¢å¼‚å¸¸ã€‚');  
                addReasoningLog('ğŸ“Š å£°çº³åˆ†æï¼šCåŒºå’ŒDåŒºæ³¢å½¢å¼‚å¸¸ï¼ŒCåŒºæŒ¯å¹…æœ€å¤§');  
            }  
        }  

        function switchToolMobile(mode) {
            if (!state.toolsUnlocked[mode]) return;
            
            state.activeMode = mode;
            
            // ç§»é™¤æ‰€æœ‰å·¥å…·çš„æç¤ºå…‰åœˆ
            ['archive', 'sound', 'thermal'].forEach(t => {
                const tab = document.getElementById(`tab-${t}`);
                if (tab) tab.classList.remove('tool-hint-active');
            });
            
            // æ›´æ–°tabçŠ¶æ€
            ['archive', 'sound', 'thermal'].forEach(t => {
                const tab = document.getElementById(`tab-${t}`);
                const panel = document.getElementById(`panel-${t}`);
                
                if (tab && panel) {
                    if (t === mode) {
                        tab.classList.add('border-b-2', 'border-blue-500', 'text-blue-400');
                        tab.classList.remove('text-slate-500', 'text-slate-300', 'text-amber-400', 'border-amber-500');
                        panel.classList.remove('hidden');
                    } else {
                        tab.classList.remove('border-b-2', 'border-blue-500', 'text-blue-400');
                        if (t === 'archive' && state.toolsUnlocked[t]) {
                            tab.classList.add('text-amber-400');
                        } else if (state.toolsUnlocked[t]) {
                            tab.classList.add('text-slate-300');
                        } else {
                            tab.classList.add('text-slate-500');
                        }
                        panel.classList.add('hidden');
                    }
                }
            });
            
            // ç‰¹å®šé€»è¾‘
            if (mode === 'archive') {
                document.getElementById('archive-modal-mobile').classList.remove('hidden');
                state.intel.archive = true;
                updateHint('> æŸ¥é˜…æ¡£æ¡ˆï¼šä»ä¸­å¯»æ‰¾å¤§åçš„å¼±ç‚¹çº¿ç´¢');
            } else {
                closeArchiveMobile();
            }
            
            if (mode === 'thermal') {
                state.intel.thermal = true;
                updateHint('> çƒ­æˆåƒå¯åŠ¨ã€‚å†·è‰²è°ƒä»£è¡¨å¤§åç»“æ„ç›¸å¯¹ç–æ¾ï¼›æš–è‰²è°ƒä»£è¡¨ç»“æ„ç´§å¯†');
                document.getElementById('thermal-close-mobile').classList.remove('hidden');
            } else {
                closeThermalMobile();
            }
            
            if (mode === 'sound') {
                state.intel.sound = true;
                updateHint('> å£°çº³æ¢æµ‹å¯åŠ¨ï¼Œåˆ†æå„åŒºåŸŸå£°æ³¢å¼‚å¸¸');
                const modal = document.getElementById('sonar-modal-mobile');
                modal.classList.remove('hidden');
                const c = document.getElementById('waveCanvasMobile');
                if (c) { c.width = c.offsetWidth; }
            } else {
                closeSonarMobile();
            }
        }

        function closeArchiveMobile() {
            const modal = document.getElementById('archive-modal-mobile');
            if (modal) modal.classList.add('hidden');
        }

        function closeSonarMobile() {
            const modal = document.getElementById('sonar-modal-mobile');
            if (modal) modal.classList.add('hidden');
        }

        function closeThermalMobile() {
            const btn = document.getElementById('thermal-close-mobile');
            if (btn) btn.classList.add('hidden');
            
            // åªåˆ‡æ¢çŠ¶æ€ï¼Œä¸æ‰“å¼€æ¡£æ¡ˆ
            state.activeMode = 'normal';
            
            // æ›´æ–°æ‰€æœ‰tabä¸ºéæ¿€æ´»çŠ¶æ€
            ['archive', 'sound', 'thermal'].forEach(t => {
                const tab = document.getElementById(`tab-${t}`);
                if (tab) {
                    tab.classList.remove('border-b-2', 'border-blue-500', 'text-blue-400');
                    if (t === 'archive') {
                        tab.classList.add('text-amber-400');
                    } else if (state.toolsUnlocked[t]) {
                        tab.classList.add('text-slate-300');
                    } else {
                        tab.classList.add('text-slate-500');
                    }
                }
                
                const panel = document.getElementById(`panel-${t}`);
                if (panel) panel.classList.add('hidden');
            });
            
            // æ˜¾ç¤ºæ¡£æ¡ˆé¢æ¿ï¼ˆä½†ä¸æ‰“å¼€æ¡£æ¡ˆæµ®çª—ï¼‰
            const archivePanel = document.getElementById('panel-archive');
            if (archivePanel) archivePanel.classList.remove('hidden');
            
            const archiveTab = document.getElementById('tab-archive');
            if (archiveTab) {
                archiveTab.classList.add('border-b-2', 'border-amber-500', 'text-amber-400');
                archiveTab.classList.remove('text-slate-300');
            }
            
            updateHint('æ¡£æ¡ˆå¼€å¯ï¼Œå†…æœ‰çº¿ç´¢');
        }

        function closeArchive() {  
            const modal = document.getElementById('archive-modal');  
            if (modal) modal.classList.add('hidden');  
        }  

        function closeArchiveMobile() {  
            const modal = document.getElementById('archive-modal-mobile');  
            if (modal) modal.classList.add('hidden');  
        }  

        function resetButtons() {  
            ['sound', 'thermal'].forEach(id => {  
                if (state.isMobile) {  
                    const btn = document.getElementById(`tab-${id}`);  
                    if (btn) {  
                        btn.disabled = true;  
                        btn.classList.add('cursor-not-allowed', 'text-slate-500');  
                        btn.classList.remove('text-slate-300', 'unlocked');  
                    }  
                } else {  
                    const btn = document.getElementById(`btn-${id}`);  
                    if (btn) {  
                        btn.disabled = true;  
                        btn.classList.add('cursor-not-allowed', 'bg-slate-800', 'border-slate-700', 'text-slate-500');  
                        btn.classList.remove('unlocked', 'bg-slate-700', 'border-slate-600', 'text-slate-300');  
                        
                        if (!btn.querySelector('svg[fill="currentColor"]')) {  
                            const lock = document.createElementNS('http://www.w3.org/2000/svg', 'svg');  
                            lock.setAttribute('class', 'ml-auto w-4 h-4 text-slate-600');  
                            lock.setAttribute('fill', 'currentColor');  
                            lock.setAttribute('viewBox', '0 0 20 20');  
                            lock.innerHTML = '<path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>';  
                            btn.appendChild(lock);  
                        }  
                    }  
                }  
            });  
        }  

        function updateAttemptsUI() {  
            const attemptsEl = document.getElementById('attempts');  
            if (attemptsEl) {  
                attemptsEl.textContent = `${state.remainingAttempts}/${state.maxAttempts}`;  
            }  
        }  

        function updateHint(text) {  
            const hintEl = state.isMobile ? document.getElementById('hint-text-mobile') : document.getElementById('hint-text');  
            if (hintEl) hintEl.textContent = text;  
        }  

        function addReasoningLog(text) {  
            if (state.isMobile) return;  
            
            const log = document.getElementById('reasoning-log');  
            if (!log) return;  
            
            if (log.querySelector('.opacity-50')) {  
                log.innerHTML = '';  
            }  
            const p = document.createElement('p');  
            p.className = 'text-xs text-blue-300 border-l-2 border-blue-500 pl-2 animate-pulse';  
            p.textContent = text;  
            log.appendChild(p);  
            setTimeout(() => p.classList.remove('animate-pulse'), 2000);  
        }  

        // ==================== è£‚çº¹ç”Ÿæˆ ====================
        function generateCracks() {
            state.cracks = [];
            state.weakPoints = [];
            
            // è®¾ç½®å›ºå®šéšæœºç§å­ï¼Œç¡®ä¿è£‚çº¹ä½ç½®ç¨³å®š
            let seed = 12345;
            const seededRandom = () => {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            };
            
            const damTop = state.height * 0.05;
            const damHeight = state.height * 0.95;
            
            // è®¡ç®—æ¯ç±³å¯¹åº”çš„åƒç´ 
            const meterToPixel = damHeight / 30;
            
            // CåŒºä½ç½® (å·¦ä¸‹)
            const cZoneX = 0;
            const cZoneY = damTop + damHeight / 2;
            const cZoneW = state.width / 2;
            const cZoneH = damHeight / 2;
            
            // CåŒºçš„ä¸€çœŸä¸€å‡ä¸¤ä¸ªè–„å¼±ç‚¹ï¼š5ç±³å¤„å’Œ10ç±³å¤„ï¼ˆä»åº•éƒ¨ç®—èµ·ï¼‰
            const weak5m = {
                x: cZoneX + cZoneW * 0.35,
                y: state.height - meterToPixel * 5,
                isReal: true,
                depth: 'deep' // é¢œè‰²ç•¥æ·±
            };
            
            const weak10m = {
                x: cZoneX + cZoneW * 0.65,
                y: state.height - meterToPixel * 10,
                isReal: false,
                depth: 'shallow'
            };
            
            state.weakPoints = [weak5m, weak10m];
            
            // === CåŒºè£‚çº¹ï¼ˆ6æ¡ï¼‰===
            // 5ç±³å¤„2æ¡ï¼ˆå·¦ä¾§ä¸ºå”¯ä¸€æ­£ç¡®ç­”æ¡ˆï¼Œå³ä¾§ä¸ºé”™è¯¯ï¼‰
            for (let i = 0; i < 2; i++) {
                const isLeft = i === 0;
                state.cracks.push({
                    x: weak5m.x + (i - 0.5) * 40,
                    y: weak5m.y + (seededRandom() - 0.5) * 30,
                    length: 20 + seededRandom() * 25,
                    angle: seededRandom() * Math.PI * 2,
                    width: 1.5 + seededRandom() * 0.5,
                    zone: 'C',
                    segments: 5 + Math.floor(seededRandom() * 3),
                    isNearWeak: isLeft,
                    weakPoint: isLeft ? weak5m : null,
                    seed: seed // ä¿å­˜ç§å­ç”¨äºç»˜åˆ¶
                });
            }
            
            // 10ç±³å¤„2æ¡
            for (let i = 0; i < 2; i++) {
                state.cracks.push({
                    x: weak10m.x + (i - 0.5) * 40,
                    y: weak10m.y + (seededRandom() - 0.5) * 30,
                    length: 20 + seededRandom() * 25,
                    angle: seededRandom() * Math.PI * 2,
                    width: 1.5 + seededRandom() * 0.5,
                    zone: 'C',
                    segments: 5 + Math.floor(seededRandom() * 3),
                    isNearWeak: true,
                    weakPoint: weak10m,
                    seed: seed
                });
            }
            
            // å…¶ä»–ä½ç½®2æ¡
            const otherHeights = [15, 22]; // 15ç±³å’Œ22ç±³
            otherHeights.forEach(height => {
                state.cracks.push({
                    x: cZoneX + cZoneW * (0.3 + seededRandom() * 0.4),
                    y: state.height - meterToPixel * height,
                    length: 18 + seededRandom() * 20,
                    angle: seededRandom() * Math.PI * 2,
                    width: 1.5 + seededRandom() * 0.5,
                    zone: 'C',
                    segments: 5 + Math.floor(seededRandom() * 3),
                    seed: seed
                });
            });
            
            // === DåŒºè£‚çº¹ï¼ˆ5æ¡ï¼‰===
            const dZoneX = state.width / 2;
            const dHeights = [5, 5, 8, 10, 10]; // 5ç±³2æ¡ã€8ç±³1æ¡ã€10ç±³2æ¡
            
            dHeights.forEach((height, idx) => {
                state.cracks.push({
                    x: dZoneX + (state.width / 2) * (0.3 + seededRandom() * 0.4),
                    y: state.height - meterToPixel * height + (seededRandom() - 0.5) * 20,
                    length: 18 + seededRandom() * 22,
                    angle: seededRandom() * Math.PI * 2,
                    width: 1.5 + seededRandom() * 0.5,
                    zone: 'D',
                    segments: 5 + Math.floor(seededRandom() * 3),
                    seed: seed
                });
            });
            
            // === AåŒºå’ŒBåŒºå„3æ¡ ===
            ['A', 'B'].forEach((zone) => {
                const isA = zone === 'A';
                const zx = isA ? 0 : state.width / 2;
                const zy = damTop;
                const zw = state.width / 2;
                const zh = damHeight / 2;
                
                for (let i = 0; i < 3; i++) {
                    state.cracks.push({
                        x: zx + zw * (0.25 + seededRandom() * 0.5),
                        y: zy + zh * (0.25 + seededRandom() * 0.5),
                        length: 18 + seededRandom() * 20,
                        angle: seededRandom() * Math.PI * 2,
                        width: 1.5 + seededRandom() * 0.5,
                        zone: zone,
                        segments: 5 + Math.floor(seededRandom() * 3),
                        seed: seed
                    });
                }
            });
        }

        // ==================== çƒ­æˆåƒå…‰æ–‘ç”Ÿæˆ ====================
        function generateThermalSpots() {
            state.thermalSpots = [];
            
            // å›ºå®šéšæœºç§å­
            let seed = 54321;
            const seededRandom = () => {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            };
            
            const damTop = state.height * 0.05;
            const damHeight = state.height * 0.95;
            const meterToPixel = damHeight / 30;
            
            // CåŒºçš„3å—å…‰æ–‘
            // å…‰æ–‘1ï¼š5ç±³å¤„ï¼Œé¢œè‰²ç•¥æ·±ï¼ˆå¯¹åº”çœŸæ­£è–„å¼±ç‚¹ï¼‰
            state.thermalSpots.push({
                x: state.width * 0.25 * 0.35,
                y: state.height - meterToPixel * 5,
                radius: 30 + seededRandom() * 20,
                intensity: 0.7, // ç•¥æ·±
                zone: 'C'
            });
            
            // å…‰æ–‘2ï¼š10ç±³å¤„ï¼Œé¢œè‰²æ­£å¸¸
            state.thermalSpots.push({
                x: state.width * 0.25 * 0.65,
                y: state.height - meterToPixel * 10,
                radius: 45 + seededRandom() * 15,
                intensity: 0.5,
                zone: 'C'
            });
            
            // å…‰æ–‘3ï¼šCåŒºå…¶ä»–ä½ç½®ï¼Œé¢œè‰²æ›´æµ…
            state.thermalSpots.push({
                x: state.width * 0.25 * 1.5,
                y: state.height - meterToPixel * 15,
                radius: 40 + seededRandom() * 15,
                intensity: 0.4,
                zone: 'C'
            });
            
            // DåŒº1å—å¤§é¢ç§¯æµ…è“å…‰æ–‘
            state.thermalSpots.push({
                x: state.width * 0.75,
                y: state.height - meterToPixel * 8,
                radius: 80 + seededRandom() * 20,
                intensity: 0.3, // é¢œè‰²æ›´æµ…
                zone: 'D'
            });
        }

        // ==================== æ¸²æŸ“å¾ªç¯ ====================
        function gameLoop() {
            if (state.gameStarted) {
                drawMainCanvas();
                drawRulerCanvas();
                drawWaveCanvas();
            }
            requestAnimationFrame(gameLoop);
        }

        function drawMainCanvas() {
            if (!state.ctx) return;
            
            const ctx = state.ctx;
            const w = state.width;
            const h = state.height;
            
            ctx.clearRect(0, 0, w, h);
            
            // æ ¹æ®æ¨¡å¼ç»˜åˆ¶
            if (state.activeMode === 'thermal') {
                drawThermalDam(ctx, w, h);
            } else {
                drawNormalDam(ctx, w, h);
            }
        }

        function drawNormalDam(ctx, w, h) {
            const damTop = h * 0.05;
            const damH = h * 0.95;
            
            // å¤§åä¸»ä½“
            const damGrad = ctx.createLinearGradient(0, damTop, 0, h);
            damGrad.addColorStop(0, '#475569');
            damGrad.addColorStop(0.5, '#334155');
            damGrad.addColorStop(1, '#1e293b');
            ctx.fillStyle = damGrad;
            ctx.fillRect(0, damTop, w, damH);
            
            // åˆ†åŒºç½‘æ ¼
            ctx.strokeStyle = 'rgba(0,0,0,0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(w / 2, damTop);
            ctx.lineTo(w / 2, h);
            ctx.moveTo(0, damTop + damH / 2);
            ctx.lineTo(w, damTop + damH / 2);
            ctx.stroke();
            
            // åŒºåŸŸæ ‡ç­¾
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            ctx.font = 'bold 36px Arial';
            ctx.fillText('A', w * 0.25 - 12, damTop + damH * 0.25);
            ctx.fillText('B', w * 0.75 - 12, damTop + damH * 0.25);
            ctx.fillText('C', w * 0.25 - 12, damTop + damH * 0.75);
            ctx.fillText('D', w * 0.75 - 12, damTop + damH * 0.75);
            
            // ç»˜åˆ¶è£‚çº¹ï¼ˆä¸è§„åˆ™å½¢çŠ¶ï¼Œä½¿ç”¨å›ºå®šè·¯å¾„ï¼‰
            state.cracks.forEach((crack) => {
                ctx.strokeStyle = '#0f172a';
                ctx.lineWidth = crack.width;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // å¦‚æœè£‚çº¹å·²æœ‰ç¼“å­˜è·¯å¾„ï¼Œç›´æ¥ä½¿ç”¨
                if (!crack.path) {
                    // é¦–æ¬¡ç”Ÿæˆè·¯å¾„å¹¶ç¼“å­˜
                    crack.path = [];
                    let currentX = crack.x;
                    let currentY = crack.y;
                    const segmentLength = crack.length / crack.segments;
                    
                    // ä½¿ç”¨è£‚çº¹è‡ªå·±çš„ç§å­ç”Ÿæˆç¨³å®šè·¯å¾„
                    let pathSeed = crack.seed || 12345;
                    const pathRandom = () => {
                        pathSeed = (pathSeed * 9301 + 49297) % 233280;
                        return pathSeed / 233280;
                    };
                    
                    crack.path.push({ x: currentX, y: currentY });
                    
                    for (let i = 0; i < crack.segments; i++) {
                        const angleVariation = (pathRandom() - 0.5) * 0.5;
                        const lengthVariation = 0.8 + pathRandom() * 0.4;
                        
                        currentX += Math.cos(crack.angle + angleVariation) * segmentLength * lengthVariation;
                        currentY += Math.sin(crack.angle + angleVariation) * segmentLength * lengthVariation;
                        
                        crack.path.push({ x: currentX, y: currentY });
                    }
                }
                
                // ç»˜åˆ¶ç¼“å­˜çš„è·¯å¾„
                ctx.beginPath();
                ctx.moveTo(crack.path[0].x, crack.path[0].y);
                for (let i = 1; i < crack.path.length; i++) {
                    ctx.lineTo(crack.path[i].x, crack.path[i].y);
                }
                ctx.stroke();
            });
        }

        function drawThermalDam(ctx, w, h) {
            const damTop = h * 0.05;
            const damH = h * 0.95;
            
            // æ•´ä½“é»„æ©™è‰²èƒŒæ™¯
            const baseGrad = ctx.createLinearGradient(0, damTop, 0, h);
            baseGrad.addColorStop(0, '#f59e0b');
            baseGrad.addColorStop(0.5, '#eab308');
            baseGrad.addColorStop(1, '#f97316');
            ctx.fillStyle = baseGrad;
            ctx.fillRect(0, damTop, w, damH);
            
            // æ·»åŠ éšæœºçƒ­ç‚¹ï¼ˆçº¢è‰²ï¼‰
            for (let i = 0; i < 8; i++) {
                const rx = Math.random() * w;
                const ry = damTop + Math.random() * damH;
                const grad = ctx.createRadialGradient(rx, ry, 0, rx, ry, 60 + Math.random() * 40);
                grad.addColorStop(0, 'rgba(239, 68, 68, 0.4)');
                grad.addColorStop(1, 'rgba(234, 179, 8, 0)');
                ctx.fillStyle = grad;
                ctx.fillRect(0, damTop, w, damH);
            }
            
            // ç»˜åˆ¶è“è‰²å…‰æ–‘ï¼ˆæ¨¡ç³Šã€ä¸è§„åˆ™ï¼‰
            state.thermalSpots.forEach(spot => {
                const blueIntensity = spot.intensity;
                
                // åˆ›å»ºä¸è§„åˆ™å…‰æ–‘ï¼ˆå¤šä¸ªåœ†å½¢å åŠ ï¼‰
                for (let i = 0; i < 3; i++) {
                    const offsetX = (Math.random() - 0.5) * spot.radius * 0.3;
                    const offsetY = (Math.random() - 0.5) * spot.radius * 0.3;
                    const subRadius = spot.radius * (0.6 + Math.random() * 0.4);
                    
                    const grad = ctx.createRadialGradient(
                        spot.x + offsetX, spot.y + offsetY, 0,
                        spot.x + offsetX, spot.y + offsetY, subRadius
                    );
                    
                    grad.addColorStop(0, `rgba(59, 130, 246, ${blueIntensity * 0.6})`);
                    grad.addColorStop(0.5, `rgba(96, 165, 250, ${blueIntensity * 0.3})`);
                    grad.addColorStop(1, 'rgba(234, 179, 8, 0)');
                    
                    ctx.fillStyle = grad;
                    ctx.fillRect(0, damTop, w, damH);
                }
            });
            
            // æ‰«æçº¿æ•ˆæœ
            ctx.fillStyle = 'rgba(0,0,0,0.08)';
            for (let y = damTop; y < h; y += 4) {
                ctx.fillRect(0, y, w, 1);
            }
            
            // åŒºåŸŸæ ‡ç­¾
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.font = 'bold 36px Arial';
            ctx.fillText('A', w * 0.25 - 12, damTop + damH * 0.25);
            ctx.fillText('B', w * 0.75 - 12, damTop + damH * 0.25);
            ctx.fillText('C', w * 0.25 - 12, damTop + damH * 0.75);
            ctx.fillText('D', w * 0.75 - 12, damTop + damH * 0.75);
        }

        function drawRulerCanvas() {
            if (!state.rulerCtx) return;
            
            const ctx = state.rulerCtx;
            const w = state.rulerCanvas.width;
            const h = state.rulerCanvas.height;
            
            ctx.clearRect(0, 0, w, h);
            
            // èƒŒæ™¯
            ctx.fillStyle = 'rgba(15, 23, 42, 0.5)';
            ctx.fillRect(0, 0, w, h);
            
            // åˆ»åº¦ï¼ˆ0-30mï¼Œä»ä¸‹åˆ°ä¸Šï¼‰
            ctx.strokeStyle = '#64748b';
            ctx.fillStyle = '#e2e8f0';
            const fontSize = state.isMobile ? 8 : 10;
            ctx.font = `${fontSize}px monospace`;
            ctx.textAlign = 'center';
            
            for (let meter = 0; meter <= 30; meter += 5) {
                const y = h - (meter / 30) * h;
                
                // åˆ»åº¦çº¿
                ctx.beginPath();
                ctx.moveTo(w * 0.3, y);
                ctx.lineTo(w * 0.7, y);
                ctx.stroke();
                
                // æ•°å­—
                ctx.fillText(`${meter}m`, w / 2, y - 3);
            }
            
            // ä¸­è½´çº¿
            ctx.strokeStyle = '#475569';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(w / 2, 0);
            ctx.lineTo(w / 2, h);
            ctx.stroke();
        }

        function drawWaveCanvas() {
            // æ¡Œé¢ç«¯
            if (!state.isMobile && state.waveCtx) {
                drawWave(state.waveCtx, state.waveCanvas);
            }
            
            // ç§»åŠ¨ç«¯
            if (state.isMobile) {
                const mobileCanvas = document.getElementById('waveCanvasMobile');
                if (mobileCanvas) {
                    const mobileCtx = mobileCanvas.getContext('2d');
                    if (mobileCtx) {
                        drawWave(mobileCtx, mobileCanvas);
                    }
                }
            }
        }
        
        function drawWave(ctx, canvas) {
            if (!ctx || !canvas) return;
            
            const w = canvas.width;
            const h = canvas.height;
            
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, w, h);
            
            const time = Date.now() * 0.003;
            const zoneW = w / 4;
            
            for (let i = 0; i < 4; i++) {
                const isAbnormal = i === 2 || i === 3; // CåŒºå’ŒDåŒº
                const isMost = i === 2; // CåŒºæœ€å¼º
                
                ctx.strokeStyle = isAbnormal ? (isMost ? '#ef4444' : '#f97316') : '#22c55e';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                const startX = i * zoneW;
                const centerY = h / 2;
                const freq = isMost ? 0.04 : (isAbnormal ? 0.08 : 0.15);
                const amp = isMost ? (h * 0.35) : (isAbnormal ? (h * 0.2) : (h * 0.1));
                
                for (let x = 0; x < zoneW; x += 2) {
                    const envelope = Math.sin((x / zoneW) * Math.PI);
                    const y = centerY + Math.sin((x + time * 30) * freq) * amp * envelope;
                    if (x === 0) ctx.moveTo(startX + x, y);
                    else ctx.lineTo(startX + x, y);
                }
                ctx.stroke();
            }
        }

        // ==================== äº¤äº’é€»è¾‘ ====================
        function handleCanvasClick(e) {
            if (!state.gameRunning) return;
            if (state.remainingAttempts <= 0) {
                updateHint('âš ï¸ å°è¯•æ¬¡æ•°å·²ç”¨å°½ï¼');
                return;
            }
            
            const rect = state.canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
            const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
            
            // å¿½ç•¥é¡¶éƒ¨æ°´é¢ç‚¹å‡»
            if (y < state.height * 0.05) return;
            
            state.clickCount++;
            
            // æ£€æµ‹æ˜¯å¦ç‚¹å‡»è£‚çº¹
            let hitCrack = null;
            let minDist = Infinity;
            
            state.cracks.forEach((crack, idx) => {
                const dist = Math.sqrt((x - crack.x) ** 2 + (y - crack.y) ** 2);
                if (dist < 25 && dist < minDist) {
                    minDist = dist;
                    hitCrack = crack;
                }
            });
            
            if (hitCrack) {
                if (hitCrack.isNearWeak && hitCrack.weakPoint && hitCrack.weakPoint.isReal) {
                    const intelCount = Object.values(state.intel).filter(Boolean).length;
                    
                    if (intelCount >= 2) {
                        // èƒœåˆ©
                        triggerVictory(x, y, hitCrack.weakPoint);
                    } else {
                        // æƒ…æŠ¥ä¸è¶³
                        state.remainingAttempts--;
                        updateAttemptsUI();
                        updateHint(`âš ï¸ å‘ç°ç–‘ä¼¼è–„å¼±ç‚¹ï¼Œä½†æƒ…æŠ¥ä¸è¶³ï¼è¯·ä½¿ç”¨æ›´å¤šå·¥å…·éªŒè¯ï¼ˆè‡³å°‘2ç§ï¼‰ã€‚å‰©ä½™ ${state.remainingAttempts} æ¬¡æœºä¼šã€‚`);
                        spawnParticles(x, y, 15, '#fbbf24');
                        
                        if (state.remainingAttempts <= 0) {
                            endGame(false, 'å°è¯•æ¬¡æ•°è€—å°½');
                        }
                    }
                } else {
                    // æ™®é€šè£‚çº¹
                    state.wrongClicks++;
                    state.remainingAttempts--;
                    updateAttemptsUI();
                    updateHint(`âŒ æ­¤å¤„ç»“æ„è¾ƒä¸ºç¨³å›ºã€‚å‰©ä½™ ${state.remainingAttempts} æ¬¡æœºä¼šã€‚`);
                    spawnParticles(x, y, 8, '#64748b');
                    
                    if (state.remainingAttempts <= 0) {
                        endGame(false, 'å°è¯•æ¬¡æ•°è€—å°½');
                    }
                }
            } else {
                // ç‚¹å‡»ç©ºç™½
                state.remainingAttempts--;
                updateAttemptsUI();
                updateHint(`ç‚¹å‡»ä½ç½®æœªå‘ç°æ˜æ˜¾è£‚çº¹ã€‚å‰©ä½™ ${state.remainingAttempts} æ¬¡æœºä¼šã€‚`);
                
                if (state.remainingAttempts <= 0) {
                    endGame(false, 'å°è¯•æ¬¡æ•°è€—å°½');
                }
            }
        }

        function handleCanvasHover(e) {
            if (!state.gameRunning) return;
            
            const rect = state.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // æ£€æµ‹é¼ æ ‡æ˜¯å¦æ‚¬åœåœ¨è£‚çº¹ä¸Š
            let foundCrack = false;
            
            for (let crack of state.cracks) {
                const dist = Math.sqrt((x - crack.x) ** 2 + (y - crack.y) ** 2);
                if (dist < 25) {
                    foundCrack = true;
                    showTooltip(e.clientX, e.clientY);
                    break;
                }
            }
            
            if (!foundCrack) {
                hideTooltip();
            }
        }

        function handleCanvasTouchMove(e) {
            if (!state.gameRunning) return;
            e.preventDefault();
            
            const rect = state.canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            let foundCrack = false;
            
            for (let crack of state.cracks) {
                const dist = Math.sqrt((x - crack.x) ** 2 + (y - crack.y) ** 2);
                if (dist < 25) {
                    foundCrack = true;
                    showTooltip(touch.clientX, touch.clientY);
                    break;
                }
            }
            
            if (!foundCrack) {
                hideTooltip();
            }
        }

        function showTooltip(clientX, clientY) {
            const tooltip = document.getElementById('crack-tooltip');
            if (!tooltip) return;
            
            clearTimeout(state.tooltipTimer);
            
            tooltip.style.left = clientX + 10 + 'px';
            tooltip.style.top = clientY - 30 + 'px';
            tooltip.style.opacity = '1';
            
            state.tooltipTimer = setTimeout(() => {
                hideTooltip();
            }, 1500);
        }

        function hideTooltip() {
            const tooltip = document.getElementById('crack-tooltip');
            if (tooltip) {
                tooltip.style.opacity = '0';
            }
            clearTimeout(state.tooltipTimer);
        }

        function spawnParticles(x, y, count, color) {
            const rect = state.canvas.getBoundingClientRect();
            
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = (rect.left + x) + 'px';
                particle.style.top = (rect.top + y) + 'px';
                particle.style.background = color || '#fff';
                document.body.appendChild(particle);
                
                const vx = (Math.random() - 0.5) * 6;
                const vy = (Math.random() - 0.5) * 6 - 2;
                
                let life = 1;
                const animate = () => {
                    life -= 0.02;
                    if (life <= 0) {
                        particle.remove();
                        return;
                    }
                    
                    const currentX = parseFloat(particle.style.left);
                    const currentY = parseFloat(particle.style.top);
                    particle.style.left = (currentX + vx) + 'px';
                    particle.style.top = (currentY + vy + (1 - life) * 3) + 'px';
                    particle.style.opacity = life;
                    
                    requestAnimationFrame(animate);
                };
                animate();
            }
        }

        function triggerVictory(x, y, weakPoint) {
            state.gameRunning = false;
            clearInterval(state.interval);
            
            const depthInfo = weakPoint.depth === 'deep' ? '5ç±³å¤„' : '10ç±³å¤„';
            updateHint(`ğŸ¯ ç²¾å‡†æ‰“å‡»ï¼æˆåŠŸå‡»ç©¿${depthInfo}çš„ä¸´æ—¶ä¿®è¡¥ç‚¹ï¼`);
            spawnParticles(x, y, 50, '#22c55e');
            
            setTimeout(() => {
                endGame(true, weakPoint);
            }, 1500);
        }

        function endGame(isVictory, data = null) {
            state.gameRunning = false;
            clearInterval(state.interval);
            
            const modal = document.getElementById('end-modal');
            const content = document.getElementById('end-content');
            
            if (!modal || !content) return;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            const intelCount = Object.values(state.intel).filter(Boolean).length;
            const usedTime = 120 - state.timer;
            
            if (isVictory) {
                const depthInfo = data.depth === 'deep' ? '5ç±³å¤„ï¼ˆé¢œè‰²ç•¥æ·±çš„å…‰æ–‘ï¼‰' : '10ç±³å¤„';
                
                content.innerHTML = `
                    <div class="text-center">
                        <svg class="w-16 md:w-20 h-16 md:h-20 text-yellow-400 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <h2 class="text-2xl md:text-3xl font-bold text-white mb-2">æˆ˜ç•¥çªç ´æˆåŠŸï¼</h2>
                        <p class="text-slate-300 mb-4 md:mb-6 text-sm md:text-base">ä½ æˆåŠŸæ‰¾åˆ°äº†CåŒº${depthInfo}çš„è–„å¼±ç‚¹</p>
                        
                        <div class="bg-slate-700/50 rounded-lg p-3 md:p-4 mb-4 border border-slate-600">
                            <h3 class="text-xs md:text-sm font-bold text-slate-300 uppercase mb-3">ä½ çš„æ¨ç†è·¯å¾„</h3>
                            <div class="space-y-2 text-xs md:text-sm text-left">
                                <div class="flex items-center gap-2 ${state.intel.archive ? 'text-green-400' : 'text-slate-500'}">
                                    <svg class="w-4 h-4 md:w-5 md:h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>æ¡£æ¡ˆè®°å½•ï¼šé”å®šCåŒº"5ç±³å’Œ10ç±³å¤„"</span>
                                </div>
                                <div class="flex items-center gap-2 ${state.intel.sound ? 'text-green-400' : 'text-slate-500'}">
                                    <svg class="w-4 h-4 md:w-5 md:h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>å£°çº³æ¢æµ‹ï¼šCåŒºå’ŒDåŒºå¼‚å¸¸</span>
                                </div>
                                <div class="flex items-center gap-2 ${state.intel.thermal ? 'text-green-400' : 'text-slate-500'}">
                                    <svg class="w-4 h-4 md:w-5 md:h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>çƒ­æˆåƒï¼šCåŒº3å—å…‰æ–‘ï¼Œå…¶ä¸­${depthInfo}é¢œè‰²ç•¥æ·±</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-900/50 to-cyan-900/50 border border-blue-500/30 rounded-lg p-3 md:p-4 mb-4 md:mb-6">
                            <p class="text-blue-200 text-xs md:text-sm italic leading-relaxed">
                                "åœ¨å¤æ‚çš„å•†ä¸šæˆ˜åœºä¸­ï¼Œç›²ç›®è¯•é”™æ˜¯æˆæœ¬æœ€é«˜çš„ç­–ç•¥ã€‚<br>
                                çœŸæ­£çš„é«˜æ‰‹ï¼Œå–„äº<strong class="text-blue-300">æ•´åˆå¤šç»´ä¿¡æ¯ã€äº¤å‰éªŒè¯</strong>ï¼Œ<br>
                                ç›´è‡³æ‰¾åˆ°é‚£ä¸ª<strong class="text-yellow-300">ä¸€å‡»å¿…ä¸­çš„æˆ˜ç•¥æ æ†ç‚¹</strong>ã€‚"
                            </p>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 md:gap-4 mb-4 md:mb-6 text-center">
                            <div class="bg-slate-800/50 rounded p-2 md:p-3">
                                <div class="text-xl md:text-2xl font-bold text-blue-400">${intelCount}/3</div>
                                <div class="text-xs text-slate-400 mt-1">æƒ…æŠ¥æ•´åˆ</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2 md:p-3">
                                <div class="text-xl md:text-2xl font-bold text-green-400">${usedTime}s</div>
                                <div class="text-xs text-slate-400 mt-1">ç”¨æ—¶</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2 md:p-3">
                                <div class="text-xl md:text-2xl font-bold text-amber-400">${state.clickCount}</div>
                                <div class="text-xs text-slate-400 mt-1">å°è¯•æ¬¡æ•°</div>
                            </div>
                        </div>
                        
                        <button onclick="restartGame()" class="w-full bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-700 hover:to-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-lg text-sm md:text-base">
                            å†æ¬¡æŒ‘æˆ˜
                        </button>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="text-center">
                        <svg class="w-16 md:w-20 h-16 md:h-20 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <h2 class="text-2xl md:text-3xl font-bold text-white mb-2">ä»»åŠ¡å¤±è´¥</h2>
                        <p class="text-slate-300 mb-4 md:mb-6 text-sm md:text-base">${data || 'æ°´ä½æŒç»­ä¸Šæ¶¨ï¼Œå†œç”°ä¾ç„¶å¹²æ—±'}</p>
                        
                        <div class="bg-slate-700/50 rounded-lg p-3 md:p-4 mb-4 md:mb-6 border border-slate-600">
                            <h3 class="text-xs md:text-sm font-bold text-slate-300 mb-2">æ­£ç¡®ç­”æ¡ˆæ­æ™“</h3>
                            <p class="text-xs md:text-sm text-slate-300 leading-relaxed">
                                çœŸæ­£çš„è–„å¼±ç‚¹éšè—åœ¨ <span class="text-yellow-400 font-bold">CåŒº</span> çš„
                                <span class="text-blue-400 font-bold">"5ç±³å¤„"</span>ï¼ˆæ¡£æ¡ˆä¸­æåˆ°çš„ä¸¤ä¸ªä¸´æ—¶ä¿®è¡¥ç‚¹ä¹‹ä¸€ï¼‰ã€‚<br><br>
                                ç»“åˆ<strong>æ¡£æ¡ˆï¼ˆ5ç±³å’Œ10ç±³å¤„ï¼‰</strong> + 
                                <strong>å£°çº³æ¢æµ‹ï¼ˆCåŒºå¼‚å¸¸ï¼‰</strong> + 
                                <strong>çƒ­æˆåƒï¼ˆ5ç±³å¤„å…‰æ–‘é¢œè‰²ç•¥æ·±ï¼‰</strong>ï¼Œ<br>
                                å°±èƒ½ç²¾å‡†å®šä½åˆ°è¿™ä¸ªæˆ˜ç•¥æ æ†ç‚¹ã€‚
                            </p>
                        </div>
                        
                        <div class="bg-blue-900/30 border border-blue-500/30 rounded-lg p-3 md:p-4 mb-4 md:mb-6">
                            <p class="text-blue-200 text-xs md:text-sm italic">
                                ğŸ’¡ æç¤ºï¼šæ¡£æ¡ˆç»™å‡ºäº†ä¸¤ä¸ªä½ç½®ï¼Œä½†åªæœ‰é€šè¿‡çƒ­æˆåƒä¸­"é¢œè‰²ç•¥æ·±"çš„å…‰æ–‘ï¼Œæ‰èƒ½ç¡®å®š5ç±³å¤„æ˜¯çœŸæ­£çš„è–„å¼±ç‚¹ã€‚
                            </p>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 mb-4 text-center text-xs">
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-lg font-bold text-slate-400">${intelCount}/3</div>
                                <div class="text-slate-500">æƒ…æŠ¥</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-lg font-bold text-slate-400">${usedTime}s</div>
                                <div class="text-slate-500">ç”¨æ—¶</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-lg font-bold text-slate-400">${state.clickCount}</div>
                                <div class="text-slate-500">å°è¯•</div>
                            </div>
                        </div>
                        
                        <button onclick="restartGame()" class="w-full bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg text-sm md:text-base">
                            é‡æ–°æŒ‘æˆ˜
                        </button>
                    </div>
                `;
            }
        }

    </script>
</body>
</html>